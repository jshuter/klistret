<project default="ci:create" xmlns:ivy="antlib:org.apache.ivy.ant">
	<taskdef resource="org/apache/ivy/ant/antlib.xml" uri="antlib:org.apache.ivy.ant" />

	<!-- edit: properties are specific to local environment -->
	<property name="tmp-destdir" location="C:/temp" />
	<property name="project-basedir" location="C:/workshop/klistret/CMDB Core" />
	<property name="dist-basedir" location="C:/workshop/downloads/klistret" />

	<property name="schema-basedir" location="${project-basedir}/src/xsd" />
	<property name="config-basedir" location="${project-basedir}/configuration" />
	<property name="bin-basedir" location="${project-basedir}/bin" />


	<ivy:settings file="${project-basedir}/ivysettings.xml" />
	<ivy:cachepath pathid="classpath.XJC" conf="xjc" file="${project-basedir}/ivy.xml" type="jar" />

	<path id="klistret.plugin.class.path">
		<fileset dir="${dist-basedir}">
			<include name="klistret.xjc.jar" />
		</fileset>
	</path>

	<target name="xjc:plugin" description="Generate XJC extensions">
		<javac srcdir="${project-basedir}/src" destdir="${tmp-destdir}" debug="on">
			<include name="com/klistret/cmdb/utility/jaxb/DateConverter.java" />
			<include name="com/klistret/cmdb/utility/jaxb/*Plugin.java" />
			<classpath>
				<path refid="classpath.XJC" />
			</classpath>
		</javac>

		<copy todir="${tmp-destdir}/META-INF">
			<fileset dir="${project-basedir}/configuration/build/META-INF" />
		</copy>

		<jar destfile="${dist-basedir}/klistret.xjc.jar">
			<fileset dir="${tmp-destdir}">
				<include name="com/klistret/cmdb/utility/jaxb/DateConverter.java" />
				<include name="com/klistret/cmdb/utility/jaxb/*Plugin.class" />
			</fileset>
			<fileset dir="${tmp-destdir}" includes="com/klistret/cmdb/utility/spring/ClassPathScanningCandidateDefinitionProvider.class" />
			<fileset dir="${tmp-destdir}" includes="META-INF/services/com.sun.tools.xjc.Plugin" />
		</jar>
	</target>

	<target name="ci:create" depends="xjc:plugin">
		<!-- Capture the path as a delimited property using the refid attribute -->
		<property name="myclasspath" refid="classpath.XJC" />
		<!-- Emit the property to the ant console -->
		<echo message="Classpath = ${myclasspath}" />

		<java classname="com.sun.tools.xjc.XJCFacade">
			<arg value="-extension" />
			<arg value="-d" />
			<arg value="${tmp-destdir}" />
			<arg value="-b" />
			<arg value="${config-basedir}/build/jaxb.binding.xml" />
			<arg value="${schema-basedir}/pojo.xsd" />
			<arg value="${schema-basedir}/commons.xsd" />
			<arg value="${schema-basedir}/xmlschemaNamespace.xsd" />
			<arg value="${schema-basedir}/element" />
			<arg value="${schema-basedir}/relation" />
			<arg value="-Xcollection-setter-injector" />
			<arg value="-Xinject-code" />
			<arg value="-XxmlRootElement" />
			<arg value="-XxmlRootElement-bases=com.klistret.cmdb.ci.commons.Base,com.klistret.cmdb.ci.pojo.Element,com.klistret.cmdb.ci.pojo.ElementType,com.klistret.cmdb.ci.pojo.Relation,com.klistret.cmdb.ci.pojo.RelationType,com.klistret.cmdb.ci.pojo.ElementQueryResponse" />
			<arg value="-XxmlNSMap" />
			<arg value="-XxmlNSMap-targets=com.klistret.cmdb.ci.pojo.Element,com.klistret.cmdb.ci.pojo.Relation,com.klistret.cmdb.ci.pojo.ElementQueryResponse" />

			<classpath>
				<path refid="classpath.XJC" />
				<pathelement location="${dist-basedir}/klistret.xjc.jar" />
			</classpath>
		</java>

		<javac srcdir="${tmp-destdir}" destdir="${tmp-destdir}" debug="on">
			<include name="com/klistret/cmdb/ci/**/*.java" />
			<classpath>
				<path refid="classpath.XJC" />
			</classpath>
		</javac>

		<jar destfile="${dist-basedir}/klistret.ci-${ivy.revision}.jar" basedir="${tmp-destdir}">
			<include name="com/klistret/cmdb/ci/**/*.class" />
		</jar>

	</target>

	<target name="ci:publish" depends="ci:create">
		<ivy:retrieve />
		<ivy:publish deliverivypattern="${project-basedir}/ivy.xml" resolver="localrepo" pubrevision="0.1" status="integration" update="true" overwrite="true">
			<artifacts pattern="${dist-basedir}/klistret.ci-[revision].[ext]" />
		</ivy:publish>
	</target>
</project>